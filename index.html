<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>V60 Timer</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="V60 Timer">

  <style>
    :root {
      color-scheme: dark;
      --bg-main: #050816;
      --bg-card: #111827;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.18);
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background:
        radial-gradient(circle at top, #1f2937, transparent 55%),
        radial-gradient(circle at bottom, #0f172a, #020617);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      color: var(--text-main);
    }
    .app {
      max-width: 480px;
      width: 100%;
      padding: 1.8rem 1.4rem 2.2rem;
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }
    .header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      justify-content: center;
    }
    .icon {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 30px rgba(34, 197, 94, 0.4);
    }
    .icon span {
      font-size: 1.4rem;
    }
    h1 {
      font-size: 1.45rem;
      margin: 0;
    }
    .subtitle {
      text-align: left;
      font-size: 0.86rem;
      color: var(--text-muted);
      margin-top: 0.1rem;
    }
    .timer-card {
      background: linear-gradient(145deg, rgba(15,23,42,0.98), rgba(15,23,42,0.9));
      border-radius: 1.6rem;
      padding: 1.3rem 1.5rem 1.4rem;
      box-shadow:
        0 20px 40px rgba(0,0,0,0.55),
        0 0 0 1px rgba(148,163,184,0.12);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.7rem;
    }
    #timer {
      font-size: 3.4rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-shadow: 0 0 16px rgba(34, 197, 94, 0.35);
    }
    .buttons {
      display: flex;
      gap: 0.7rem;
      margin-top: 0.4rem;
    }
    button {
      font-size: 1rem;
      padding: 0.7rem 1.5rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.07s ease, box-shadow 0.07s ease, background 0.15s ease;
      font-weight: 500;
    }
    button:active {
      transform: scale(0.97);
    }
    #startStop {
      background: var(--accent);
      color: #022c22;
      box-shadow: 0 10px 25px rgba(34, 197, 94, 0.45);
      min-width: 120px;
    }
    #startStop:hover {
      background: #16a34a;
    }
    #reset {
      background: rgba(31,41,55, 0.85);
      color: var(--text-main);
      box-shadow: 0 6px 18px rgba(15,23,42,0.8);
    }
    #reset:hover {
      background: rgba(55,65,81, 0.95);
    }
    #message {
      min-height: 1.5rem;
      font-weight: 600;
      text-align: center;
      font-size: 0.95rem;
      color: var(--accent);
    }
    .steps {
      margin-top: 0.4rem;
      width: 100%;
    }
    .steps-title {
      font-size: 0.88rem;
      font-weight: 600;
      margin-bottom: 0.4rem;
      color: var(--text-muted);
      text-align: left;
      width: 100%;
    }
    ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      width: 100%;
    }
    li {
      background: rgba(15,23,42, 0.9);
      border-radius: 0.9rem;
      padding: 0.5rem 0.75rem;
      font-size: 0.86rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1px solid rgba(148,163,184,0.25);
    }
    li span.time {
      font-feature-settings: "tnum";
      font-variant-numeric: tabular-nums;
      font-weight: 600;
      color: var(--accent);
    }
    li span.desc {
      opacity: 0.9;
      margin-left: 0.6rem;
      color: var(--text-main);
    }
    li.done {
      background: rgba(22,163,74,0.15);
      border-color: rgba(34,197,94,0.7);
      text-decoration: line-through;
      color: var(--text-muted);
    }
    li.current {
      box-shadow: 0 0 0 1px var(--accent-soft), 0 0 0 1px var(--accent);
    }
    .footer-hint {
      margin-top: 1.1rem;
      font-size: 0.8rem;
      text-align: center;
      color: var(--text-muted);
    }
    @media (max-width: 400px) {
      #timer {
        font-size: 3rem;
      }
      .timer-card {
        padding-inline: 1.1rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="icon"><span>☕️</span></div>
      <div>
        <h1>V60 Timer</h1>
        <div class="subtitle">300 g · vertidos guiados con sonido</div>
      </div>
    </header>

    <main class="timer-card">
      <div id="timer">00:00</div>
      <div class="buttons">
        <button id="startStop">Iniciar</button>
        <button id="reset">Reiniciar</button>
      </div>
      <div id="message"></div>

      <section class="steps">
        <div class="steps-title">Pasos del vertido:</div>
        <ul id="steps"></ul>
      </section>
    </main>

    <div class="footer-hint">
      Una vez abierto en Safari, toca compartir →
      <strong>“Añadir a pantalla de inicio”</strong> para usarlo como app.
    </div>
  </div>

  <script>
    const steps = [
      { time: 0,   label: "00:00 – 40 g (Bloom)", grams: "40 g",  note: "Bloom" },
      { time: 45,  label: "00:45 – 120 g",        grams: "120 g", note: "Segundo vertido" },
      { time: 90,  label: "01:30 – 180 g",        grams: "180 g", note: "Tercer vertido" },
      { time: 135, label: "02:15 – 240 g",        grams: "240 g", note: "Cuarto vertido" },
      { time: 180, label: "03:00 – 300 g",        grams: "300 g", note: "Finalizar" }
    ];

    const timerEl = document.getElementById("timer");
    const startStopBtn = document.getElementById("startStop");
    const resetBtn = document.getElementById("reset");
    const stepsList = document.getElementById("steps");
    const messageEl = document.getElementById("message");

    steps.forEach((step, index) => {
      const li = document.createElement("li");
      li.dataset.index = index;
      li.innerHTML =
        '<span class="time">' + step.label.slice(0,5) + '</span>' +
        '<span class="desc">' + step.grams + " · " + step.note + "</span>";
      stepsList.appendChild(li);
      step.element = li;
    });

    let running = false;
    let startTime = null;
    let elapsed = 0;
    let intervalId = null;
    let nextStepIndex = 0;
    let audioCtx = null;

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
    }

    function updateTimer() {
      const now = Date.now();
      const totalSeconds = Math.floor((now - startTime) / 1000);
      elapsed = totalSeconds;
      timerEl.textContent = formatTime(elapsed);
      checkSteps();
    }

    function ensureAudioContext() {
      if (!audioCtx) {
        try {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
          console.log("AudioContext no disponible", e);
        }
      }
    }

    function playBeepPattern() {
      ensureAudioContext();
      if (!audioCtx) return;

      const now = audioCtx.currentTime;

      const beep = (startTime, freq, duration = 0.18) => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = "sine";
        osc.frequency.setValueAtTime(freq, startTime);
        gain.gain.setValueAtTime(0.0001, startTime);
        gain.gain.exponentialRampToValueAtTime(0.3, startTime + 0.03);
        gain.gain.exponentialRampToValueAtTime(0.0001, startTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(startTime);
        osc.stop(startTime + duration);
      };

      beep(now, 900);
      beep(now + 0.24, 1300);
    }

    function showMessage(text) {
      messageEl.textContent = text;
      if (text) {
        setTimeout(() => {
          if (messageEl.textContent === text) {
            messageEl.textContent = "";
          }
        }, 4000);
      }
    }

    function checkSteps() {
      if (nextStepIndex >= steps.length) return;
      const step = steps[nextStepIndex];

      if (elapsed >= step.time) {
        step.element.classList.add("done");
        step.element.classList.remove("current");

        playBeepPattern();
        if (navigator.vibrate) {
          navigator.vibrate([200, 80, 200]);
        }
        showMessage(step.label);

        nextStepIndex++;
        if (nextStepIndex < steps.length) {
          steps[nextStepIndex].element.classList.add("current");
        }
      }
    }

    function startTimer() {
      running = true;
      startStopBtn.textContent = "Pausar";
      startTime = Date.now() - elapsed * 1000;
      intervalId = setInterval(updateTimer, 200);

      if (nextStepIndex < steps.length) {
        steps[nextStepIndex].element.classList.add("current");
      }

      ensureAudioContext();
    }

    function stopTimer() {
      running = false;
      startStopBtn.textContent = "Reanudar";
      clearInterval(intervalId);
    }

    function resetTimer() {
      stopTimer();
      elapsed = 0;
      timerEl.textContent = "00:00";
      startStopBtn.textContent = "Iniciar";
      nextStepIndex = 0;
      messageEl.textContent = "";
      steps.forEach(step => {
        step.element.classList.remove("done", "current");
      });
    }

    startStopBtn.addEventListener("click", () => {
      if (!running) {
        startTimer();
      } else {
        stopTimer();
      }
    });

    resetBtn.addEventListener("click", resetTimer);
  </script>
</body>
</html>
