<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>V60 Timer</title>

  <!-- Modo “app” en iOS cuando se agrega a pantalla de inicio -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="V60 Timer">

  <style>
    :root {
      color-scheme: light dark;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #f5efe6, #e0d5c7);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }
    .app {
      max-width: 480px;
      width: 100%;
      padding: 1.5rem 1.2rem 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }
    .header {
      display: flex;
      align-items: center;
      gap: 0.7rem;
      justify-content: center;
    }
    .icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: #8b5a2b;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    }
    .icon span {
      font-size: 1.4rem;
    }
    h1 {
      font-size: 1.4rem;
      margin: 0;
    }
    .subtitle {
      text-align: center;
      font-size: 0.9rem;
      opacity: 0.8;
      margin-top: -0.4rem;
    }
    .timer-card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 1.4rem;
      padding: 1.2rem 1.4rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.6rem;
    }
    #timer {
      font-size: 3.2rem;
      font-weight: 700;
      letter-spacing: 0.08em;
    }
    .buttons {
      display: flex;
      gap: 0.6rem;
      margin-top: 0.4rem;
    }
    button {
      font-size: 1rem;
      padding: 0.7rem 1.4rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    #startStop {
      background: #111;
      color: #fff;
      min-width: 110px;
    }
    #reset {
      background: #e5e5e5;
      color: #111;
    }
    #message {
      min-height: 1.5rem;
      font-weight: 600;
      text-align: center;
      font-size: 0.95rem;
    }
    .steps {
      margin-top: 0.3rem;
    }
    .steps-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.3rem;
    }
    ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }
    li {
      background: rgba(255,255,255,0.9);
      border-radius: 0.8rem;
      padding: 0.4rem 0.7rem;
      font-size: 0.88rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    li span.time {
      font-feature-settings: "tnum";
      font-variant-numeric: tabular-nums;
      font-weight: 600;
    }
    li span.desc {
      opacity: 0.85;
      margin-left: 0.6rem;
    }
    li.done {
      background: #d1fae5;
      text-decoration: line-through;
    }
    li.current {
      border: 2px solid #111;
    }
    .footer-hint {
      margin-top: 1.1rem;
      font-size: 0.8rem;
      text-align: center;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="icon"><span>☕️</span></div>
      <div>
        <h1>V60 Timer</h1>
        <div class="subtitle">300 g · vertidos guiados con sonido</div>
      </div>
    </header>

    <main class="timer-card">
      <div id="timer">00:00</div>
      <div class="buttons">
        <button id="startStop">Iniciar</button>
        <button id="reset">Reiniciar</button>
      </div>
      <div id="message"></div>

      <section class="steps">
        <div class="steps-title">Pasos:</div>
        <ul id="steps"></ul>
      </section>
    </main>

    <div class="footer-hint">
      Consejo: una vez abierto desde Safari, toca el botón de compartir y elige
      <strong>“Añadir a pantalla de inicio”</strong> para usarlo como app.
    </div>
  </div>

  <script>
    const steps = [
      { time: 0,   label: "00:00 – 40 g (Bloom)", grams: "40 g",  note: "Bloom" },
      { time: 45,  label: "00:45 – 120 g",        grams: "120 g", note: "Segundo vertido" },
      { time: 90,  label: "01:30 – 180 g",        grams: "180 g", note: "Tercer vertido" },
      { time: 135, label: "02:15 – 240 g",        grams: "240 g", note: "Cuarto vertido" },
      { time: 180, label: "03:00 – 300 g",        grams: "300 g", note: "Finalizar" }
    ];

    const timerEl = document.getElementById("timer");
    const startStopBtn = document.getElementById("startStop");
    const resetBtn = document.getElementById("reset");
    const stepsList = document.getElementById("steps");
    const messageEl = document.getElementById("message");

    steps.forEach((step, index) => {
      const li = document.createElement("li");
      li.dataset.index = index;
      li.innerHTML = '<span class="time">' + step.label.slice(0,5) + '</span>' +
                     '<span class="desc">' + step.grams + " · " + step.note + "</span>";
      stepsList.appendChild(li);
      step.element = li;
    });

    let running = false;
    let startTime = null;
    let elapsed = 0;
    let intervalId = null;
    let nextStepIndex = 0;
    let audioCtx = null;

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
    }

    function updateTimer() {
      const now = Date.now();
      const totalSeconds = Math.floor((now - startTime) / 1000);
      elapsed = totalSeconds;
      timerEl.textContent = formatTime(elapsed);
      checkSteps();
    }

    function ensureAudioContext() {
      if (!audioCtx) {
        try {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
          console.log("AudioContext no disponible", e);
        }
      }
    }

    function playBeepPattern() {
      ensureAudioContext();
      if (!audioCtx) return;

      const now = audioCtx.currentTime;

      const beep = (startTime, freq, duration = 0.18) => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = "sine";
        osc.frequency.setValueAtTime(freq, startTime);
        gain.gain.setValueAtTime(0.0001, startTime);
        gain.gain.exponentialRampToValueAtTime(0.3, startTime + 0.03);
        gain.gain.exponentialRampToValueAtTime(0.0001, startTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(startTime);
        osc.stop(startTime + duration);
      };

      // Pequeño patrón: beep–beep
      beep(now, 880);
      beep(now + 0.25, 1200);
    }

    function showMessage(text) {
      messageEl.textContent = text;
      if (text) {
        setTimeout(() => {
          if (messageEl.textContent === text) {
            messageEl.textContent = "";
          }
        }, 4000);
      }
    }

    function checkSteps() {
      if (nextStepIndex >= steps.length) return;
      const step = steps[nextStepIndex];

      if (elapsed >= step.time) {
        step.element.classList.add("done");
        step.element.classList.remove("current");

        playBeepPattern();
        if (navigator.vibrate) {
          navigator.vibrate([200, 80, 200]);
        }
        showMessage(step.label);

        nextStepIndex++;
        if (nextStepIndex < steps.length) {
          steps[nextStepIndex].element.classList.add("current");
        }
      }
    }

    function startTimer() {
      running = true;
      startStopBtn.textContent = "Pausar";
      startTime = Date.now() - elapsed * 1000;
      intervalId = setInterval(updateTimer, 200);

      if (nextStepIndex < steps.length) {
        steps[nextStepIndex].element.classList.add("current");
      }

      ensureAudioContext();
    }

    function stopTimer() {
      running = false;
      startStopBtn.textContent = "Reanudar";
      clearInterval(intervalId);
    }

    function resetTimer() {
      stopTimer();
      elapsed = 0;
      timerEl.textContent = "00:00";
      startStopBtn.textContent = "Iniciar";
      nextStepIndex = 0;
      messageEl.textContent = "";
      steps.forEach(step => {
        step.element.classList.remove("done", "current");
      });
    }

    startStopBtn.addEventListener("click", () => {
      if (!running) {
        startTimer();
      } else {
        stopTimer();
      }
    });

    resetBtn.addEventListener("click", resetTimer);
  </script>
</body>
</html>
